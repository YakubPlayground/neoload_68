name: NeoLoadAsCode

variables:
- constant:
    name: app_server_hostname
    value: ushahidi

servers:
- name: app_server
  host: ${app_server_hostname}
  scheme: http

user_paths:
- name: api_config
  actions:
    steps:
    - delay: 1s
    - request:
        url: /platform/api/v3/config
        server: app_server
        method: GET

- name: api_savedsearch
  init:
    steps:
    - transaction:
        name: Obtain OAuth Token
        description: Grab the OAuth client secret from the dynamic JS in our app
        steps:
        - request:
            url: /js/bundle.js
            server: app_server
            method: GET
            extractors:
            - name: oauth_client_secret
              regexp: OAUTH_CLIENT_SECRET:"(.*?)"
        - request:
            url: /platform/oauth/token
            server: app_server
            method: POST
            headers:
            - accept: application/json
            - Content-Type: application/json
            body: '{"grant_type":"client_credentials","client_id":"ushahidiui","client_secret":"${oauth_client_secret}","scope":"posts media forms api tags savedsearches sets users stats layers config messages notifications contacts roles permissions csv"}'
            extractors:
            - name: oauth_bearer
              jsonpath: $.access_token
              regexp: (.*)
              match_number: 1
              extract_once: true
  actions:
    steps:
    - delay: 1s
    - request:
        url: /js/bundle.js
        server: app_server
        method: GET
        headers:
        - Authorization: Bearer ${oauth_bearer}

populations:
- name: API
  user_paths:
  - name: api_config
    distribution: 50%
  - name: api_savedsearch
    distribution: 50%

scenarios:
- name: MixedScenarioWithMonitoring
  populations:
  - name: API
    rampup_load:
      duration: 30m
      min_users: 1
      max_users: 5
      increment_users: 1
      increment_every: 10s
  - name: popPost
    rampup_load:
      duration: 30m
      min_users: 1
      max_users: 40
      increment_users: 1
      increment_every: 15s
  - name: dynatracePop
    constant_load:
      duration: 30m
      users: 1
  - name: popSelenium
    constant_load:
      duration: 30m
      users: 4
